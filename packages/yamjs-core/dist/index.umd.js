(function(u,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(u=typeof globalThis<"u"?globalThis:u||self,g(u["yamjs-core"]={}))})(this,function(u){"use strict";const g=Java.type("org.bukkit.Bukkit"),y=g.getPluginManager(),h=y.getPlugin(Yam.getConfig().pluginName),C=g.getServer(),d=Java.type("java.lang.Runtime"),l=Java.type("java.lang.System"),R=e=>Object.keys(e).reduce((t,o)=>{var i;const a=e[o];return t[o]=(i=a==null?void 0:a.toString)==null?void 0:i.call(a),t},{}),N=()=>{const e=Java.type("java.lang.Long"),n=Java.type("org.bukkit.Bukkit"),t=n.getPluginManager().getPlugin("YamJS").getDataFolder().getParentFile().getParentFile(),o=n.getPluginManager().getPlugins().map(i=>i.getName());return{yamJS:{coreVersion:"0.0.1",pluginVersion:"0.0.1",legacyVersion:"0.0.1",instance:R(Yam.instance)},server:{players:`${n.getOnlinePlayers().size()} / ${n.getMaxPlayers()}`,plugins:o,minecraftVersion:n.getVersion(),bukkitVersion:n.getBukkitVersion(),onlineMode:n.getOnlineMode()},java:{version:l.getProperty("java.version"),vendor:l.getProperty("java.vendor"),vendorUrl:l.getProperty("java.vendor.url"),home:l.getProperty("java.home"),command:l.getProperty("sun.java.command"),timezone:l.getProperty("user.timezone")},system:{os:{name:l.getProperty("os.name"),version:l.getProperty("os.version"),arch:l.getProperty("os.arch")},cpu:{cores:d.getRuntime().availableProcessors()},memory:{free:d.getRuntime().freeMemory(),max:d.getRuntime().maxMemory()==e.MAX_VALUE?"unlimited":d.getRuntime().maxMemory(),total:d.getRuntime().totalMemory()},storage:{free:t==null?void 0:t.getFreeSpace(),total:t==null?void 0:t.getTotalSpace(),usable:t==null?void 0:t.getUsableSpace()}}}};let T={};"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("").forEach(function(e,n){T[e]=n});function O(e){let n=[],s=0,t=0;for(let o=0;o<e.length;o+=1){let a=T[e[o]];if(a===void 0)throw new Error("Invalid character ("+e[o]+")");const i=a&32;if(a&=31,t+=a<<s,i)s+=5;else{const r=t&1;t>>>=1,r?n.push(t===0?-2147483648:-t):n.push(t),t=s=0}}return n}function V(e){const s=e.mappings.split(";").map(t=>t.split(",")).map(t=>t.map(o=>O(o)));return{sources:e.sources,mappings:s,startOffset:0}}function H(e){const n=JSON.parse(e);return V(n)}const S=new Map;function _(e,n,s){const t=H(n);return t?(t.startOffset=s,S.set(e,t),!0):!1}function A({mappings:e,sources:n},s){let t=0,o=0,a=0;for(let i=0;i<e.length;i++)if(e[i].forEach(c=>{t+=c[2]??0,o+=c[1]??0}),i+1===s)return a=t+1,{file:n[o],line:a};throw new Error(`source map failed for line ${s}`)}function B(e,n){const s=S.get(`${e}`);if(s){if(n-=s.startOffset,n<=0)return{file:e,line:n};const t=A(s,n);return t.file.startsWith("webpack://test/")&&(t.file=t.file.replace("webpack://test/","")),t.file.startsWith("../")&&(t.file=t.file.replace("../","./")),t}else return{file:e,line:n}}const P=Java.type("org.bukkit.Bukkit"),U=Java.type("net.kyori.adventure.text.minimessage.MiniMessage"),x="      ",D=["yamjs.Interop.catchError","com.oracle.truffle.polyglot.PolyglotFunctionProxyHandler.invoke","jdk.proxy1.$Proxy75.run"],W=["webpack/runtime/make"],G=["catchAndLogUnhandledErrors"],X=e=>{const n=[];n.push(e.name);for(let s=0;s<e.stack.length;s++){const t=e.stack[s];if(t.javaFrame){if(D.includes(`${t.source}.${t.methodName}`))continue;n.push(`${x}at ${t.source}.${t.methodName}(${t.fileName}:${t.line})`);continue}const o=B(t.source,t.line);if(W.some(i=>o.file.includes(i))||G.includes(t.methodName)||o.line===0)continue;let a=t.methodName||"<anonymous>";t.methodName===":=>"&&(a="<anonymous>"),n.push(`${x}at ${a} (${o.file}:${o.line}) [${t.source}:${t.line}]`)}return n.join(`
`)},k=(e,n)=>{var t,o,a;let s;try{const i=((a=(o=(t=e==null?void 0:e.getClass)==null?void 0:t.call(e))==null?void 0:o.getName)==null?void 0:a.call(o))??void 0;i!=null&&i.includes("yamjs.JsError")?s=e:s=__interop.catchError(()=>{throw e});const r=X(s);n&&P.getConsoleSender().sendMessage(n),P.getConsoleSender().sendMessage(U.miniMessage().deserialize(`<red>${r}</red>`))}catch(i){console.log("ERROR: There was an error logging an error. Please report to YamJS. ",i.name),console.log(i.message,i.stack),console.log("Original error: ",e==null?void 0:e.name),console.log(e==null?void 0:e.message,e==null?void 0:e.stack)}},E=(e,n)=>{try{return e()}catch(s){k(s,n)}},q=(e,n)=>(...s)=>{try{return e(...s)}catch(t){k(t,n)}},K=Java.type("org.bukkit.event.EventPriority"),Q=Java.type("org.bukkit.event.Listener"),$=()=>new(Java.extend(Q,{})),j=$(),Z=(e,n,s="HIGHEST",t=j)=>{const o={priority:"priority"in n?n.priority:s,script:"script"in n?n.script:n},a=e.class.toString();y.registerEvent(e.class,t,K.valueOf(o.priority),(i,r)=>{r instanceof e&&E(()=>{o.script(r)},`An error occured while attempting to handle the "${a}" event!`)},h)},m=(()=>{const e={};let n=!1,s=0;const t=async()=>{Yam.reload()},o=async()=>{var i;const a={...e};for(const r in a){console.log(`Closing ${e[r].name}`);const c=e[r];try{await((i=c.fn)==null?void 0:i.call(c))}catch(f){console.error(f)}delete e[r]}};return{isReloading:()=>n,reload:async()=>{if(console.log("Reloading"),n){console.log("Force reloading"),t();return}n=!0,await o(),t()},register:(a,i)=>{const r=s++;return e[r]={name:a,fn:i},{unregister:()=>delete e[r]}},initialize:()=>{Yam.instance.setOnCloseFn(async()=>{await o()})}}})();let v;const ee=(...e)=>{v===void 0&&(v=Yam.getConfig().verbose),v&&console.log(...e)},I=Symbol("TickContext"),te=()=>{const e=p[I];if(e.isActive){for(const n of e.tickFns)n(e.tick);e.tick%20===0&&ee("Tick",e.tick),e.tick+=1}},p=(()=>{const e={tick:0,task:void 0,isActive:!1,tickFns:[]},n=()=>{e.isActive=!0,Yam.instance.setTickFn(te)},s=async()=>{e.isActive=!1};return{[I]:e,start:n,stop:s,getTick:()=>e.tick,registerTickFn:t=>{e.tickFns.push(t)}}})(),ne=e=>e,ie=e=>e,M=(()=>{const e={nextId:0},n=new Map,s=i=>{n.delete(i)},t=(i,r,c)=>{const f=ie((c==null?void 0:c.nextId)??e.nextId++),ce=ne(p.getTick()+Math.max(r,1));return n.set(f,{baseTick:r,tick:ce,fn:i,reset:(c==null?void 0:c.reset)||!1,id:f}),f},o=i=>{n.delete(i.id),i.fn(),i.reset&&t(i.fn,i.baseTick,{reset:i.reset,nextId:i.id})},a=i=>{for(const[,r]of n)i>=r.tick&&o(r)};return{add:t,run:a,remove:s,initialize:()=>{p.registerTickFn(i=>a(i))}}})(),J=(e,n,s)=>{const t=n/50;return M.add(q(e,"Unhandled timer"),t,s)},F=(e,n)=>J(e,n),se=(e,n)=>J(e,n,{reset:!0}),oe=e=>F(e,0),w=e=>M.remove(e),ae=()=>{globalThis.setTimeout=F,globalThis.setInterval=se,globalThis.setImmediate=oe,globalThis.clearTimeout=w,globalThis.clearInterval=w},L=Java.type("org.bukkit.event.HandlerList");let Y=!1;const b=()=>{Y||(p.start(),M.initialize(),ae(),m.initialize(),Yam.instance.setLoggerFn(e=>k(e)),Yam.getMeta()==="yamjs"?m.register("Event Listeners",()=>{L.unregisterAll(h)}):m.register("Context Event Listeners",()=>{L.unregisterAll(j)}),Y=!0)};Yam.getConfig().initialize&&b();const z=Symbol("internal"),re={initialize:b,reload:m.reload,logError:k,catchAndLogUnhandledError:E,cacheSourceMap:_,getDebugInfo:N,registerEvent:Z,createEventListener:$,manager:y,plugin:h,server:C,[z]:{reloadHandler:m}};u.default=re,u.initialize=b,u.internal=z,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
