(function(r,d){typeof exports=="object"&&typeof module<"u"?d(exports):typeof define=="function"&&define.amd?define(["exports"],d):(r=typeof globalThis<"u"?globalThis:r||self,d(r["yamjs-core"]={}))})(this,function(r){"use strict";let d={};"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("").forEach(function(e,n){d[e]=n});function E(e){let n=[],i=0,t=0;for(let o=0;o<e.length;o+=1){let c=d[e[o]];if(c===void 0)throw new Error("Invalid character ("+e[o]+")");const s=c&32;if(c&=31,t+=c<<i,s)i+=5;else{const a=t&1;t>>>=1,a?n.push(t===0?-2147483648:-t):n.push(t),t=i=0}}return n}function S(e){const i=e.mappings.split(";").map(t=>t.split(",")).map(t=>t.map(o=>E(o)));return{sources:e.sources,mappings:i,startOffset:0}}function w(e){const n=JSON.parse(e);return S(n)}const T=new Map;function C(e,n,i){const t=w(n);return t?(t.startOffset=i,T.set(e,t),!0):!1}function F({mappings:e,sources:n},i){let t=0,o=0,c=0;for(let s=0;s<e.length;s++)if(e[s].forEach(l=>{t+=l[2]??0,o+=l[1]??0}),s+1===i)return c=t+1,{file:n[o],line:c};throw new Error(`source map failed for line ${i}`)}function j(e,n){const i=T.get(`${e}`);if(i){if(n-=i.startOffset,n<=0)return{file:e,line:n};const t=F(i,n);return t.file.startsWith("webpack://test/")&&(t.file=t.file.replace("webpack://test/","")),t.file.startsWith("../")&&(t.file=t.file.replace("../","./")),t}else return{file:e,line:n}}const y=Java.type("org.bukkit.Bukkit"),z=Java.type("net.kyori.adventure.text.minimessage.MiniMessage"),v="      ",R=["yamjs.Interop.catchError","com.oracle.truffle.polyglot.PolyglotFunctionProxyHandler.invoke","jdk.proxy1.$Proxy75.run"],N=["webpack/runtime/make"],Y=["catchAndLogUnhandledErrors"],O=e=>{const n=[];n.push(e.name);for(let i=0;i<e.stack.length;i++){const t=e.stack[i];if(t.javaFrame){if(R.includes(`${t.source}.${t.methodName}`))continue;n.push(`${v}at ${t.source}.${t.methodName}(${t.fileName}:${t.line})`);continue}const o=j(t.source,t.line);if(N.some(s=>o.file.includes(s))||Y.includes(t.methodName)||o.line===0)continue;let c=t.methodName||"<anonymous>";t.methodName===":=>"&&(c="<anonymous>"),n.push(`${v}at ${c} (${o.file}:${o.line}) [${t.source}:${t.line}]`)}return n.join(`
`)},f=(e,n)=>{var t,o,c;let i;try{const s=((c=(o=(t=e==null?void 0:e.getClass)==null?void 0:t.call(e))==null?void 0:o.getName)==null?void 0:c.call(o))??void 0;s!=null&&s.includes("yamjs.JsError")?i=e:i=__interop.catchError(()=>{throw e});const a=O(i);n&&y.getConsoleSender().sendMessage(n),y.getConsoleSender().sendMessage(z.miniMessage().deserialize(`<red>${a}</red>`))}catch(s){console.log("ERROR: There was an error logging an error. Please report to YamJS. ",s.name),console.log(s.message,s.stack),console.log("Original error: ",e==null?void 0:e.name),console.log(e==null?void 0:e.message,e==null?void 0:e.stack)}},_=(e,n)=>{try{return e()}catch(i){f(i,n)}},A=(e,n)=>(...i)=>{try{return e(...i)}catch(t){f(t,n)}},M=(()=>{const e={};let n=!1,i=0;const t=async()=>{Yam.reload()},o=async()=>{var s;const c={...e};for(const a in c){console.log(`Closing ${e[a].name}`);const l=e[a];try{await((s=l.fn)==null?void 0:s.call(l))}catch(u){console.error(u)}delete e[a]}};return{isReloading:()=>n,reload:async()=>{if(console.log("Reloading"),n){console.log("Force reloading"),t();return}n=!0,await o(),t()},register:(c,s)=>{const a=i++;return e[a]={name:c,fn:s},{unregister:()=>delete e[a]}},initialize:()=>{Yam.instance.setOnCloseFn(async()=>{await o()})}}})();let g;const J=(...e)=>{g===void 0&&(g=Yam.getConfig().verbose),g&&console.log(...e)},b=Symbol("TickContext"),L=()=>{const e=m[b];if(e.isActive){for(const n of e.tickFns)n(e.tick);e.tick%20===0&&J("Tick",e.tick),e.tick+=1}},m=(()=>{const e={tick:0,task:void 0,isActive:!1,tickFns:[]},n=()=>{e.isActive=!0,Yam.instance.setTickFn(L)},i=async()=>{e.isActive=!1};return{[b]:e,start:n,stop:i,getTick:()=>e.tick,registerTickFn:t=>{e.tickFns.push(t)}}})(),H=e=>e,P=e=>e,h=(()=>{const e={nextId:0},n=new Map,i=s=>{n.delete(s)},t=(s,a,l)=>{const u=P((l==null?void 0:l.nextId)??e.nextId++),q=H(m.getTick()+Math.max(a,1));return n.set(u,{baseTick:a,tick:q,fn:s,reset:(l==null?void 0:l.reset)||!1,id:u}),u},o=s=>{n.delete(s.id),s.fn(),s.reset&&t(s.fn,s.baseTick,{reset:s.reset,nextId:s.id})},c=s=>{for(const[,a]of n)s>=a.tick&&o(a)};return{add:t,run:c,remove:i,initialize:()=>{m.registerTickFn(s=>c(s))}}})(),x=(e,n,i)=>{const t=n/50;return h.add(A(e,"Unhandled timer"),t,i)},I=(e,n)=>x(e,n),U=(e,n)=>x(e,n,{reset:!0}),B=e=>I(e,0),$=e=>h.remove(e),V=()=>{globalThis.setTimeout=I,globalThis.setInterval=U,globalThis.setImmediate=B,globalThis.clearTimeout=$,globalThis.clearInterval=$};let k=!1;const p=()=>{console.log("Initializing YamJS...",k),!k&&(m.start(),h.initialize(),V(),M.initialize(),Yam.instance.setLoggerFn(e=>f(e)),k=!0)};Yam.getConfig().initialize&&p();const W={initialize:p,reload:M.reload,logError:f,catchAndLogUnhandledError:_,cacheSourceMap:C};r.default=W,r.initialize=p,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
