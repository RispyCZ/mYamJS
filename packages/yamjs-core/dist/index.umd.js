(function(g,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(g=typeof globalThis<"u"?globalThis:g||self,l(g["yamjs-core"]={}))})(this,function(g){"use strict";const l=Java.type("java.lang.Runtime"),u=Java.type("java.lang.System"),R=()=>{const e=Java.type("java.lang.Long"),n=Java.type("org.bukkit.Bukkit"),t=n.getPluginManager().getPlugin("YamJS").getDataFolder().getParentFile().getParentFile(),i=n.getPluginManager().getPlugins().map(o=>o.getName());return{yamJS:{coreVersion:"0.0.1",pluginVersion:"0.0.1",legacyVersion:"0.0.1"},server:{players:`${n.getOnlinePlayers().size()} / ${n.getMaxPlayers()}`,plugins:i,minecraftVersion:n.getVersion(),bukkitVersion:n.getBukkitVersion(),onlineMode:n.getOnlineMode()},java:{version:u.getProperty("java.version"),vendor:u.getProperty("java.vendor"),vendorUrl:u.getProperty("java.vendor.url"),home:u.getProperty("java.home"),command:u.getProperty("sun.java.command"),timezone:u.getProperty("user.timezone")},system:{os:{name:u.getProperty("os.name"),version:u.getProperty("os.version"),arch:u.getProperty("os.arch")},cpu:{cores:l.getRuntime().availableProcessors()},memory:{free:l.getRuntime().freeMemory(),max:l.getRuntime().maxMemory()==e.MAX_VALUE?"unlimited":l.getRuntime().maxMemory(),total:l.getRuntime().totalMemory()},storage:{free:t.getFreeSpace(),total:t.getTotalSpace(),usable:t.getUsableSpace()}}}};let T={};"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("").forEach(function(e,n){T[e]=n});function E(e){let n=[],s=0,t=0;for(let i=0;i<e.length;i+=1){let a=T[e[i]];if(a===void 0)throw new Error("Invalid character ("+e[i]+")");const o=a&32;if(a&=31,t+=a<<s,o)s+=5;else{const c=t&1;t>>>=1,c?n.push(t===0?-2147483648:-t):n.push(t),t=s=0}}return n}function F(e){const s=e.mappings.split(";").map(t=>t.split(",")).map(t=>t.map(i=>E(i)));return{sources:e.sources,mappings:s,startOffset:0}}function J(e){const n=JSON.parse(e);return F(n)}const M=new Map;function z(e,n,s){const t=J(n);return t?(t.startOffset=s,M.set(e,t),!0):!1}function w({mappings:e,sources:n},s){let t=0,i=0,a=0;for(let o=0;o<e.length;o++)if(e[o].forEach(r=>{t+=r[2]??0,i+=r[1]??0}),o+1===s)return a=t+1,{file:n[i],line:a};throw new Error(`source map failed for line ${s}`)}function C(e,n){const s=M.get(`${e}`);if(s){if(n-=s.startOffset,n<=0)return{file:e,line:n};const t=w(s,n);return t.file.startsWith("webpack://test/")&&(t.file=t.file.replace("webpack://test/","")),t.file.startsWith("../")&&(t.file=t.file.replace("../","./")),t}else return{file:e,line:n}}const b=Java.type("org.bukkit.Bukkit"),Y=Java.type("net.kyori.adventure.text.minimessage.MiniMessage"),S="      ",L=["yamjs.Interop.catchError","com.oracle.truffle.polyglot.PolyglotFunctionProxyHandler.invoke","jdk.proxy1.$Proxy75.run"],N=["webpack/runtime/make"],O=["catchAndLogUnhandledErrors"],V=e=>{const n=[];n.push(e.name);for(let s=0;s<e.stack.length;s++){const t=e.stack[s];if(t.javaFrame){if(L.includes(`${t.source}.${t.methodName}`))continue;n.push(`${S}at ${t.source}.${t.methodName}(${t.fileName}:${t.line})`);continue}const i=C(t.source,t.line);if(N.some(o=>i.file.includes(o))||O.includes(t.methodName)||i.line===0)continue;let a=t.methodName||"<anonymous>";t.methodName===":=>"&&(a="<anonymous>"),n.push(`${S}at ${a} (${i.file}:${i.line}) [${t.source}:${t.line}]`)}return n.join(`
`)},m=(e,n)=>{var t,i,a;let s;try{const o=((a=(i=(t=e==null?void 0:e.getClass)==null?void 0:t.call(e))==null?void 0:i.getName)==null?void 0:a.call(i))??void 0;o!=null&&o.includes("yamjs.JsError")?s=e:s=__interop.catchError(()=>{throw e});const c=V(s);n&&b.getConsoleSender().sendMessage(n),b.getConsoleSender().sendMessage(Y.miniMessage().deserialize(`<red>${c}</red>`))}catch(o){console.log("ERROR: There was an error logging an error. Please report to YamJS. ",o.name),console.log(o.message,o.stack),console.log("Original error: ",e==null?void 0:e.name),console.log(e==null?void 0:e.message,e==null?void 0:e.stack)}},A=(e,n)=>{try{return e()}catch(s){m(s,n)}},_=(e,n)=>(...s)=>{try{return e(...s)}catch(t){m(t,n)}},p=(()=>{const e={};let n=!1,s=0;const t=async()=>{Yam.reload()},i=async()=>{var o;const a={...e};for(const c in a){console.log(`Closing ${e[c].name}`);const r=e[c];try{await((o=r.fn)==null?void 0:o.call(r))}catch(d){console.error(d)}delete e[c]}};return{isReloading:()=>n,reload:async()=>{if(console.log("Reloading"),n){console.log("Force reloading"),t();return}n=!0,await i(),t()},register:(a,o)=>{const c=s++;return e[c]={name:a,fn:o},{unregister:()=>delete e[c]}},initialize:()=>{Yam.instance.setOnCloseFn(async()=>{await i()})}}})();let h;const U=(...e)=>{h===void 0&&(h=Yam.getConfig().verbose),h&&console.log(...e)},x=Symbol("TickContext"),B=()=>{const e=f[x];if(e.isActive){for(const n of e.tickFns)n(e.tick);e.tick%20===0&&U("Tick",e.tick),e.tick+=1}},f=(()=>{const e={tick:0,task:void 0,isActive:!1,tickFns:[]},n=()=>{e.isActive=!0,Yam.instance.setTickFn(B)},s=async()=>{e.isActive=!1};return{[x]:e,start:n,stop:s,getTick:()=>e.tick,registerTickFn:t=>{e.tickFns.push(t)}}})(),H=e=>e,D=e=>e,k=(()=>{const e={nextId:0},n=new Map,s=o=>{n.delete(o)},t=(o,c,r)=>{const d=D((r==null?void 0:r.nextId)??e.nextId++),K=H(f.getTick()+Math.max(c,1));return n.set(d,{baseTick:c,tick:K,fn:o,reset:(r==null?void 0:r.reset)||!1,id:d}),d},i=o=>{n.delete(o.id),o.fn(),o.reset&&t(o.fn,o.baseTick,{reset:o.reset,nextId:o.id})},a=o=>{for(const[,c]of n)o>=c.tick&&i(c)};return{add:t,run:a,remove:s,initialize:()=>{f.registerTickFn(o=>a(o))}}})(),P=(e,n,s)=>{const t=n/50;return k.add(_(e,"Unhandled timer"),t,s)},j=(e,n)=>P(e,n),W=(e,n)=>P(e,n,{reset:!0}),X=e=>j(e,0),$=e=>k.remove(e),q=()=>{globalThis.setTimeout=j,globalThis.setInterval=W,globalThis.setImmediate=X,globalThis.clearTimeout=$,globalThis.clearInterval=$};let y=!1;const v=()=>{console.log("Initializing YamJS...",y),!y&&(f.start(),k.initialize(),q(),p.initialize(),Yam.instance.setLoggerFn(e=>m(e)),y=!0)};Yam.getConfig().initialize&&v();const I=Symbol("internal"),G={initialize:v,reload:p.reload,logError:m,catchAndLogUnhandledError:A,cacheSourceMap:z,getDebugInfo:R,[I]:{reloadHandler:p}};g.default=G,g.initialize=v,g.internal=I,Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
